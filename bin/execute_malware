#!/bin/bash

if [ -z "$SANDBOX" ]
then
    echo "missing \$SANDBOX environment variable"
    exit 1
fi

PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
vm_cmd='VBoxManage -q'

# parse switch arguments
while getopts 'h' argv
do
    case "$argv" in 
        h)
            echo "usage: $0 base_sandbox new_sandbox malware"
            exit 0
            ;;
    esac
done

# parse the rest
shift $((OPTIND - 1))
src_vm="$1"
dst_vm="$2"
malware="$3"

# create the sandbox to run it in
"$SANDBOX/bin/create_sandbox" "$src_vm" "$dst_vm"

# start the sandbox
"$SANDBOX/bin/start_sandbox" "$dst_vm"

# wait for the ready.txt file to appear
echo "waiting for $dst_vm to start..."
while :
do
    if [ -e "$SANDBOX/shared/$dst_vm/ready.txt" ]
    then
        break
    fi

    sleep 1
done

# copy the malware to the host
echo "copying $malware to vm"
$vm_cmd guestcontrol "$dst_vm" copyto "$malware" "C:\\Documents and Settings\\John Smith\\Desktop" --username 'John Smith' --password 1234

# execute the start.bat script on the desktop
echo "starting analysis tools"
$vm_cmd guestcontrol "$dst_vm" execute --image 'Y:\scripts\start.bat' --username 'John Smith' --password '1234' --wait-exit

echo "exec $malware"
$vm_cmd guestcontrol "$dst_vm" execute --image "C:\\Documents and Settings\\John Smith\\Desktop\\$malware" --username 'John Smith' --password '1234' &

echo "waiting for a while ..."
sleep 60

echo "stopping analysis tools"
$vm_cmd guestcontrol "$dst_vm" execute --image 'Y:\scripts\stop.bat' --username 'John Smith' --password '1234' --wait-exit
